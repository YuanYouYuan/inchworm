function torque = torque(th, dth, ddth)

load('physical-parameter.mat');

th1 = th(1,:);
th2 = th(2,:);
th3 = th(3,:);
dth1 = dth(1,:);
dth2 = dth(2,:);
dth3 = dth(3,:);
ddth1 = ddth(1,:);
ddth2 = ddth(2,:);
ddth3 = ddth(3,:);

ddk(1,:) = M1*X1^2*ddth1...
           +0.5*M2*(2*L1^2*ddth1+2*X2^2*(ddth1+ddth2)...
                    +2*L1*X2*cos(th2).*(2*ddth1+ddth2)...
                    -2*L1*X2*sin(th2).*(2*dth1+dth2).*dth2)...
           +0.5*M3*(2*L1^2*ddth1+2*L2^2*(ddth1+ddth2)...
                    +2*X3^2*(ddth1+ddth2+ddth3)...
                    +2*L1*L2*cos(th2).*(2*ddth1+ddth2)...
                    -2*L1*L2*sin(th2).*(2*dth1+dth2).*dth2...
                    +2*L2*X3*cos(th3).*(2*ddth1+2*ddth2+ddth3)...
                    -2*L2*X3*sin(th3).*(2*dth1+2*dth2+dth3).*dth3...
                    +2*L1*X3*cos(th2+th3).*(2*ddth1+ddth2+ddth3)...
                    -2*L1*X3*sin(th2+th3).*(dth2+dth3).*(2*dth1+dth2+dth3))...
           +I1*ddth1+I2*(ddth1+ddth2)+I3*(ddth1+ddth2+ddth3); 
       
ddk(2,:) = M2*(X2^2*(ddth1+ddth2)...
                 +L1*X2*(cos(th2).*ddth1-dth1.*dth2.*sin(th2)))...
        +M3*(L2^2*(ddth1+ddth2)...
             +X3^2*(ddth1+ddth2+ddth3)...
             +L1*L2*(cos(th2).*ddth1-sin(th2).*dth1.*dth2)...
             +L2*X3*(cos(th3).*(2*ddth1+2*ddth2+ddth3)...
             -sin(th3).*(2*dth1+2*dth2+dth3).*dth3)...
             +L1*X3*(cos(th2+th3).*ddth1-sin(th2+th3).*(dth2+dth3).*dth1))...
        +I2*(ddth1+ddth2)+I3*(ddth1+ddth2+ddth3);  
    
dk(1,:) = zeros(size(th1));    
dk(2,:) = -1*(M2*L2*X2*(dth1.^2+dth1.*dth2).*sin(th2)...
                +M3*(L1*L2*(dth1.^2+dth1.*dth2).*sin(th2)...
                +L1*X3*(dth1.^2+dth1.*dth2+dth1.*dth3).*sin(th2+th3)));
       
du(1,:) = -M1*G*X1*sin(th1)...
        -M2*G*(L1*sin(th1)+X2*sin(th1+th2))...
        -M3*G*(L1*sin(th1)+L2*sin(th1+th2)+X3*sin(th1+th2+th3));
    
du(2,:) = -G*(M2*X2*sin(th1+th2)...
        +M3*(L2*sin(th1+th2)+X3*sin(th1+th2+th3)));
    
torque = ddk - dk +du;
